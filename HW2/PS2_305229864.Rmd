---
header-includes:
- \usepackage{amssymb, amsmath, amsthm}
- \usepackage{tabu}
- \newcommand{\E}{\mathbb{E}}
- \newcommand{\var}{{\rm Var}}
- \newcommand{\N}{\mathcal{N}}
output: pdf_document
---
  
\noindent \begin{tabu} to \textwidth {@{}X[4 l] @{}X[r]}
\textbf{Problem Set 2}           & \\ 
\textbf{MFE 431: Quantitative Asset Management}   & \\ 
\textbf{Professor: Bernard Herskovic}         & \\
\textbf{Student: Xiahao Wang}         & \\
\textbf{Name of whom I discussed this problem set with: Yu Yue, Sumeng Wang}
\end{tabu}


## Question 1

\textbf{Summary:}

The resulting dataset:

```{r echo=FALSE}
library(data.table)
Monthly_CRSP_Bonds <- as.data.table(read.csv("Monthly_CRSP_Bonds.csv"))
Monthly_CRSP_Bonds
```

1. \textbf{Universe of Bonds: } 

Following the instruction on the problem set 2, Download the monthly bond market data from WRDS. 
Download the data from December 1925 to December 2018 so that you can get lagged total market capitalisation for portfolio weights calculation later on.

TMRETNUA is the Monthly unadjusted return. TMTOTOUT is the total amount outstanding, which is used as market capitalisation.

2. \textbf{Missing returns: } 

   * Handle Missing Data denoted by the CRSP: CRSP denotes missing return as -99. Replace -99 as NA 
```{r, eval=FALSE}
# Filter out missing Monthly Unadjusted Return
  bonddata[,`:=`(TMRETNUA, ifelse(TMRETNUA == -99.0, NA, TMRETNUA))]
```

  * Note: Missing return shouldn't be simply removed as the TMTOTOUT might not be NAs. We still need the data to calculate total market cap.





```{r, eval=FALSE}
 # remove NAs
  crsp_monthly <- crsp_monthly[PRC != "NA"]
  crsp_monthly <- crsp_monthly[RET != "NA"]
  crsp_monthly <- crsp_monthly[cumDivRet != "NA"]
  crsp_monthly <- crsp_monthly[mktCapLagged != "NA"]
``` 

3. \textbf{Delisting return calculation:}

To calculate the cum-dividend return, let return be cum-dividend return if delisting return is missing. 

If delisting return is not missing and return is missing, let delisting return be just cum-dividend return.

If both are not missing, use the formula from lecture notes:  (1 + DLRET)(1 + RET) - 1  to get the return.

Delisting return that are not numeric are converted to NAs and removed later on.

code:
```{r, eval=FALSE}
# calculates the cum-Dividend returns
crsp_monthly[, `:=`(cumDivRet, ifelse(is.na(DLRET),RET,ifelse(is.na(RET), DLRET, (1+DLRET)*(1+RET)-1 )))]
```

4. \textbf{Market Capitalisation calculation: }
There are some price that are negative, I take the absolute value for both price and shares outstanding and multiply them together to get the market capitalisation. Also I shift the market cap by 1 period for each firm. 

```{r, eval=FALSE}
# calculate the marketcap
crsp_monthly[, `:=`(ME, abs(PRC) * abs(SHROUT))]

#lag the market cap of each firm
crsp_monthly[, mktCapLagged := shift(ME), by=c("PERMNO")]
```

5. \textbf{Portfolio Weights: }

Value-weight the cum-dividend return by lagged market cap: $Weight_i = \frac{MarketCap_{i-1}}{Total \space MarketCap_{i-1}}$

For equal weight, just take the mean of returns for each period.

```{r eval=FALSE}
 # value weight portfolio, this might be wrong, let's see
  valueweight <- crsp_monthly[,list(Stock_Vw_Ret = weighted.mean(cumDivRet, mktCapLagged, na.rm = TRUE)),
                                    by=list(Year, Month)]
  # equal weight portfolio
  equalweight <- crsp_monthly[,list(Stock_Ew_Ret = mean(cumDivRet)),by=list(Year, Month)]
```

6. \textbf{Sample Period: }
As I need to lag the market capitalisation while acquring data from Jan 1926 to Dec 2018, I have obtained data starting from Dec 1925 so that I have data for Jan 1926. 

7. \textbf{Definition of portfolio Weights: }

As explained in part 5, portfolio return is the sum of all weighted return for that period. 

$$portfolio \space Return_i = \Sigma^{n}_{i=1} w_i * r_i$$
Where n is the number of stocks at that time. 



## Question 2

\textbf{Sample Data: } 

  * Download Fama French 3 fator from the website
  * Divide both Excess Return and Risk Free by 100 as the numbers are in percentage
  * Truncated result from Qn1 to start from July 1929

\textbf{Annualized Mean:}

I use the monthly mean return and multiply by 12 to get annual data

\textbf{Annualized Standard Deviation:}

I use the monthly standard deviation return and multiply by $\sqrt{12}$ to get annualized data

\textbf{Sharpe Ratio:}
$$Sharpe \space Ratio = \frac{Annualized \space Mean}{Annualized \space Standard \space Deviation}$$
\textbf{Skewness and Kurtosis:}

Using library called `moments` to obtain the statistics.


\textbf{Summary: }

```{r echo=FALSE}
library(moments)

# load data from FF website
FF_mkt <- as.data.table(read.csv("F-F_Research_Data_Factors.CSV"))

# load data from Qn 1 output
Monthly_CRSP_Stocks <- as.data.table(read.csv("Monthly_CRSP_Stocks.csv"))

PS1_Q2 <- function(FF_mkt, Monthly_CRSP_Stocks){
  # set column names to preferred column names
  colnames(FF_mkt) <- c("date", "Mkt_RF","SMB","HML","RF")
  
  # subtset Monthly_CRSP_Stocks to contain only data from 1926 July
  Monthly_CRSP_Stocks <- Monthly_CRSP_Stocks[7:dim(Monthly_CRSP_Stocks)[1],]
  
  # set the Risk free rate to decimal numbers
  FF_mkt[, RF := RF  /100]
  FF_mkt[, Mkt_RF := Mkt_RF/100]
  
  # put risk free rate in Monthly_CRSP_Stocks
  Monthly_CRSP_Stocks <- cbind(Monthly_CRSP_Stocks, RFAunnual=FF_mkt$RF)
  
  # calculate the estimated return
  Monthly_CRSP_Stocks[, EstimatedExMktRet := Stock_Vw_Ret - RFAunnual]
  
  # put estimated return in Monthly_CRSP_Stocks
  Monthly_CRSP_Stocks <- cbind(Monthly_CRSP_Stocks,ActualExMktRet=FF_mkt$Mkt_RF)
  
  # get Estimated and actual 
  ret <- Monthly_CRSP_Stocks[,.(EstimatedExMktRet,ActualExMktRet)] 
  
  AnnualizedMean <- c(mean(ret$EstimatedExMktRet) * 12 , mean(ret$ActualExMktRet) * 12)
  AnnualizedSD <- c(sd(ret$EstimatedExMktRet) * sqrt(12) , sd(ret$ActualExMktRet) * sqrt(12))
  AnnualizeSR <- c(AnnualizedMean[1]/AnnualizedSD[1], AnnualizedMean[2]/AnnualizedSD[2])
  Skewness <- c(skewness(ret$EstimatedExMktRet),skewness(ret$ActualExMktRet))
  ExcessKurtosis <-  c(kurtosis(ret$EstimatedExMktRet),kurtosis(ret$ActualExMktRet))-3
  # find the annualized return, annualized volatility, sharpe ratio, skewness and excess kurtosis
  summary <- data.table( Stats= c("Annualized Mean", "Annualized SD", "Sharpe Ratio","Skewness","Excess Kurtosis"),
      EstimatedExMktRet = c(AnnualizedMean[1], AnnualizedSD[1], AnnualizeSR[1],Skewness[1],ExcessKurtosis[1]),
                        ActualExMktRet = c(AnnualizedMean[2], AnnualizedSD[2], AnnualizeSR[2],Skewness[2],ExcessKurtosis[2]))
  
  return(summary)
}

PS1_Q2_ans <- PS1_Q2(FF_mkt, Monthly_CRSP_Stocks)
PS1_Q2_ans

```



## Question 3

\textbf{Sample Data: }

Truncated result from Qn1 to start from July 1929

Find:
  * Correlation between estimated excess return and actual excess return
  * Maximum absolute difference between the two returns

\textbf{Summary: }

The correlation is almost 1 and, but the difference between the replicated portfolio and the one from French website is not zero.

This could be due to the high precision used in the replicated portfolio (10 decimal places) where the data from Fama French has precision up to only 3 digits for excess return. 

Another reason could be due to the change in historical data from CRSP:http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/changes_crsp.html

Quote from the website:
Please note: CRSP has recently completed the Pre62 Daily Data Series Project. The addition of these new daily data results in changes to month-end prices and to dividend ex-dates. These changes have resulted in many small changes to historical returns on my website.

```{r echo=FALSE}
# load data from FF website
FF_mkt <- as.data.table(read.csv("F-F_Research_Data_Factors.CSV"))

# load data from Qn 1 output
Monthly_CRSP_Stocks <- as.data.table(read.csv("Monthly_CRSP_Stocks.csv"))

PS1_Q3 <- function(FF_mkt,Monthly_CRSP_Stocks){
  colnames(FF_mkt) <- c("date", "Mkt_RF","SMB","HML","RF")
  
  # subtset Monthly_CRSP_Stocks to contain only data from 1926 July
  Monthly_CRSP_Stocks <- Monthly_CRSP_Stocks[7:dim(Monthly_CRSP_Stocks)[1],]
  
  # set the Risk free rate to decimal numbers
  FF_mkt[, RF := RF  /100]
  FF_mkt[, Mkt_RF := Mkt_RF/100]
  
  # put risk free rate in Monthly_CRSP_Stocks
  Monthly_CRSP_Stocks <- cbind(Monthly_CRSP_Stocks, RFAunnual=FF_mkt$RF)
  
  # calculate the estimated return
  Monthly_CRSP_Stocks[, EstimatedExMktRet := Stock_Vw_Ret - RFAunnual]
  
  # put estimated return in Monthly_CRSP_Stocks
  Monthly_CRSP_Stocks <- cbind(Monthly_CRSP_Stocks,ActualExMktRet=FF_mkt$Mkt_RF)
  
  # get Estimated and actual 
  ret <- Monthly_CRSP_Stocks[,.(EstimatedExMktRet,ActualExMktRet)] 
  
  summary <- c(cor(ret$EstimatedExMktRet,ret$ActualExMktRet), max(abs(ret$EstimatedExMktRet - ret$ActualExMktRet)))
  names(summary) <- c("Correlation","Max difference")
  return(summary)
}

PS1_Q3_ans <- PS1_Q3(FF_mkt,Monthly_CRSP_Stocks)
PS1_Q3_ans
```






